---
title: "SF COVID-19 Status"
author: "Nick DiQuattro"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    # toc_float: true
    theme: readable
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 16, message = FALSE,
                      out.width = "100%", fig.height = 8)

library(tidyverse)
library(patchwork)
library(lubridate)
library(slider)

theme_set(theme_linedraw(20))
```

# Daily Growth
Data Source: [data.sfgov.org](https://data.sfgov.org/COVID-19/COVID-19-Cases-Summarized-by-Date-Transmission-and/tvq9-ec9w)

## The Whole Mess

```{r growth_chart}
sf_daily_count <- read_csv("https://data.sfgov.org/resource/gyr2-k29z.csv")

sf_daily_count %>% 
  mutate(cmean = slide_dbl(new_cases, mean, .before = 7)) %>%
  ggplot(aes(specimen_collection_date, new_cases)) +
    geom_col() +
    geom_line(aes(y = cmean)) +
    scale_x_datetime(date_labels = "%B %Y") +
    labs(x = "Day", y = "New Cases", color = "Events", fill = "Vs. Previous Day",
         caption = "Trend line indicates 7 day rolling mean") +
    theme(legend.position = "top")
```

## Recent Mess
```{r recent}
sf_daily_count %>% 
  filter(specimen_collection_date > (now() - weeks(4))) %>% 
  mutate(cmean = slide_dbl(new_cases, mean, .before = 7)) %>%
  ggplot(aes(specimen_collection_date, new_cases)) +
    geom_col(alpha = .7) +
    geom_line(aes(y = cmean), color = "blue") +
    scale_x_datetime(date_breaks = "2 day", date_labels = "%D") +
    labs(x = "Day", y = "New Cases", color = "Events", fill = "Vs. Previous Day",
         caption = "Trend line indicates 7 day rolling mean", title = "Last 4 Weeks") +
    theme(legend.position = "top", axis.text.x = element_text(angle = 90))
```


# Testing
Data Source: [data.sfgov.org](https://data.sfgov.org/COVID-19/COVID-19-Tests/nfpa-mg4g)
```{r testing}
sf_tests <- read_csv("https://data.sfgov.org/resource/nfpa-mg4g.csv")

sf_tests %>% 
  filter(specimen_collection_date > (now() - months(3))) %>% 
  mutate(cmean = slide_dbl(pct, mean, .before = 7)) %>%
  ggplot(aes(specimen_collection_date, pct)) +
    geom_col(alpha = .6) +
    geom_line(aes(y = cmean), color = "blue") +
    scale_y_continuous(labels = scales::label_percent())  +
    scale_x_datetime(date_breaks = "2 week", date_labels = "%B %d") +
    labs(x = "Day", y = "% Testing Positive", caption = " Trend line indicates 7 day rolling mean.",
         title = "Positivity Rate")

sf_tests %>% 
  filter(specimen_collection_date > (now() - months(3))) %>% 
  mutate(cmean = slide_dbl(tests, mean, .before = 7)) %>%
  ggplot(aes(specimen_collection_date, tests)) +
    geom_col(alpha = .6) +
    geom_line(aes(y = cmean)) +
    scale_y_continuous(labels = scales::label_comma())  +
    scale_x_datetime(date_breaks = "2 week", date_labels = "%B %d") +
    labs(x = "Day", y = "# of Tests Conducted", caption = "Trend line indicates 7 day rolling mean.", title = "Daily Count of Tests")
```
